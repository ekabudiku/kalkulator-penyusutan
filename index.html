<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kalkulator Properti</title>
  <style>
    /* 1. VARIABEL WARNA */
    :root {
      --bg: #f0f2f5;
      --card-bg: #ffffff; 
      --text-color: #333; 
      --accent-color: #007bff; 
      --accent-hover: #0056b3; 
      --delete-color: #dc3545;
      --delete-hover: #c82333;
      --border-color: #dee2e6; 
      --result-bg: #e9ecef; 
      --result-final-bg: #d1e7dd;
      --result-final-text: #0a3622;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.08); 
      --input-bg: #fff;
    }

    /* 2. DARK MODE */
    body.dark {
      --bg: #121212;
      --card-bg: #1e1e1e;
      --text-color: #e0e0e0;
      --accent-color: #4dabf7;
      --accent-hover: #1c7ed6;
      --delete-color: #ff6b6b;
      --delete-hover: #fa5252;
      --border-color: #333;
      --result-bg: #343a40;
      --result-final-bg: #143e3d;
      --result-final-text: #a6d9b8;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      --input-bg: #2d2d2d;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 0;
      background: var(--bg); color: var(--text-color);
      line-height: 1.6;
      transition: background 0.3s, color 0.3s;
    }

    .container {
      width: 100%; max-width: 1200px;
      margin: 0 auto; padding: 1rem;
      box-sizing: border-box;
    }

    /* HEADER */
    .header-wrapper {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
      text-align: center;
      position: relative;
    }

    .topbar { 
  position: absolute; 
  top: 1rem; 
  left: 50%; 
  transform: translateX(-50%); /* Trik agar benar-benar di tengah */
  right: auto;
}

    #darkModeToggle {
      background: transparent; border: 1px solid var(--border-color);
      color: var(--text-color); padding: .3rem .6rem;
      border-radius: 50px; cursor: pointer; font-size: 1.2rem;
    }

    /* GRID LAYOUT (2 KOLOM) */
    #formContainer, #output {
      display: grid;
      grid-template-columns: 1fr; /* Default Mobile */
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    @media (min-width: 768px) {
      #formContainer, #output {
        grid-template-columns: repeat(2, 1fr); 
      }
    }

    /* CARD STYLES */
    .sampel, .result {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      height: 100%; 
      display: flex; flex-direction: column;
      box-sizing: border-box;
      position: relative; 
    }

    .sampel h3, .result h4 {
      margin-top: 0; color: var(--accent-color);
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 0.8rem; margin-bottom: 1rem;
      font-size: 1.25rem;
    }

    /* Tombol Hapus */
    .btn-delete {
      position: absolute;
      top: 1rem; right: 1rem;
      background: var(--delete-color);
      color: white; border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-delete:hover { background: var(--delete-hover); }

    /* FORM ELEMENTS */
    label { display: block; margin-top: 1rem; font-weight: 600; font-size: 0.9rem; opacity: 0.9; }
    input, select {
      width: 100%; padding: 0.75rem; margin-top: 0.4rem;
      border-radius: 8px; border: 1px solid var(--border-color);
      background: var(--input-bg); color: var(--text-color);
      box-sizing: border-box;
    }

    /* BUTTONS MAIN */
    .button-container {
      display: flex; flex-direction: column; align-items: center;
      gap: 1rem; margin: 2rem 0; padding: 1rem;
      background: var(--card-bg); border-radius: 12px;
      box-shadow: var(--shadow);
    }
    button.main-btn {
      width: 100%; max-width: 300px; padding: 0.9rem 1.5rem;
      border: none; border-radius: 8px; font-weight: bold;
      cursor: pointer; background: var(--accent-color); color: #fff;
    }
    button.main-btn:hover { background: var(--accent-hover); transform: translateY(-2px); }

    /* RESULT STYLES (ORIGINAL) */
    .result-line {
      display: flex; justify-content: space-between;
      padding: 0.5rem 0; font-size: 0.95rem;
      border-bottom: 1px solid var(--border-color);
    }
    .result-line:last-child { border-bottom: none; }
    .result-line strong { text-align: right; }

    .result-final {
      text-align: center; padding: 0.8rem;
      border-radius: 8px; margin-top: 0.8rem;
      background: var(--result-final-bg);
      color: var(--result-final-text);
      grid-column: 1 / -1; 
    }
    .result-final .value {
      font-size: 1.5rem; font-weight: bold;
      display: block; margin-top: 0.3rem;
    }

    @media (min-width: 768px) {
      .button-container { flex-direction: row; justify-content: center; }
    }
  </style>
</head>
<body>
<div class="container">
  
  <div class="header-wrapper">
    <div class="topbar">
      <button id="darkModeToggle" onclick="toggleDarkMode()">üåô/‚òÄÔ∏è</button>
    </div>
    <h2>Kalkulator Penyusutan</h2>
    
  </div>

  <div id="formContainer"></div>

  <div class="button-container">
    <button class="main-btn" onclick="tambahSampel()">+ Tambah Sampel</button>
    <button class="main-btn" onclick="hitungMulti()">Hitung Semua</button>
  </div>

  <div id="output"></div>
</div>

<script>
// ====== Tabel Penyusutan (TETAP SAMA) ======
const tabelPenyusutan = {
  "rumah": {
    "low": {
      "BS":[0,4,8,11,14,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16],
      "B":[0,5,9,13,15,18,21,24,27,31,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34],
      "S":[0,6,10,14,18,22,26,29,32,35,38,41,44,47,50,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52,52],
      "J":[0,7,12,17,22,26,30,34,38,41,44,47,50,53,56,59,62,64,66,68,70,70,70,70,70,70,70,70,70,70,70,70,70,70,70,70,70,70,70,70,70,70,70,70,70,70,70,70,70,70,70],
      "JS":[0,8,14,20,25,30,35,39,43,47,50,53,56,59,62,64,66,68,70,72,74,76,77,78,79,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80]
    },
    "high": {
      "BS":[0,3,5,7,10,12,14,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15],
      "B":[0,4,7,10,13,16,19,22,24,26,28,30,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32],
      "S":[0,5,9,13,17,20,23,26,29,32,35,38,40,42,44,46,48,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50],
      "J":[0,6,11,16,20,24,28,31,34,37,40,43,46,49,52,54,56,58,60,62,64,66,67,67,67,67,67,67,67,67,67,67,67,67,67,67,67,67,67,67,67,67,67,67,67,67,67,67,67,67,67],
      "JS":[0,7,11,16,21,27,31,35,38,43,47,50,53,56,58,60,63,65,67,69,71,73,75,76,77,78,79,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80]
    }
  },
  "ruko": {
    "low": {
      "BS":[0,3,7,10,12,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14],
      "B":[0,4,8,11,14,17,20,23,26,28,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30,30],
      "S":[0,5,9,13,17,21,25,29,32,35,38,41,44,47,49,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51,51],
      "J":[0,6,10,14,18,22,26,30,34,38,41,44,47,50,53,56,58,60,62,64,66,66,66,66,66,66,66,66,66,66,66,66,66,66,66,66,66,66,66,66,66,66,66,66,66,66,66,66,66,66,66],
      "JS":[0,7,11,15,19,23,27,31,35,39,43,47,50,53,56,59,62,64,66,68,70,72,74,76,77,78,78,78,78,78,78,78,78,78,78,78,78,78,78,78,78,78,78,78,78,78,78,78,78,78,78]
    },
    "high": {
      "BS":[0,2,4,6,8,10,12,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13],
      "B":[0,3,5,8,10,13,15,17,20,22,24,26,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28],
      "S":[0,4,7,10,14,18,21,24,27,30,33,36,39,41,43,45,47,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49,49],
      "J":[0,5,9,13,17,21,24,29,32,35,38,41,44,47,49,51,53,55,57,59,61,63,65,65,65,65,65,65,65,65,65,65,65,65,65,65,65,65,65,65,65,65,65,65,65,65,65,65,65,65,65],
      "JS":[0,6,10,14,18,22,26,30,34,38,41,44,47,50,52,54,56,58,60,62,64,66,68,70,72,74,76,77,77,77,77,77,77,77,77,77,77,77,77,77,77,77,77,77,77,77,77,77,77,77,77]
    }
  }
};

// ============ Utility ============
function formatRupiah(el){
  let v=el.value.replace(/\D/g,'');
  el.value=v?new Intl.NumberFormat('id-ID').format(v):'';
}

let counterSampel=0; // Counter unik untuk ID

function tambahSampel(){
  counterSampel++;
  const c=document.getElementById("formContainer");
  const d=document.createElement("div");
  d.className="sampel"; 
  d.id="sampel"+counterSampel; // ID unik berdasarkan counter
  d.innerHTML=`
    <button class="btn-delete" onclick="hapusSampel(${counterSampel})">Hapus</button>
    <h3>Sampel ${counterSampel}</h3>
    <label>Jenis Properti</label>
    <select id="jenisProperti${counterSampel}" onchange="toggleInput(${counterSampel})">
      <option value="rumah">Rumah</option>
      <option value="ruko">Ruko</option>
      <option value="lahan">Lahan Kosong</option>
    </select>
    <label>Status Kepemilikan</label>
    <select id="status${counterSampel}">
      <option value="HM">HM</option><option value="HGB">HGB</option><option value="TMA">TMA</option><option value="HP">HP</option>
    </select>
    <label>Jenis Data</label>
    <select id="jenis${counterSampel}">
      <option value="Penawaran">Penawaran</option><option value="Transaksi">Transaksi</option><option value="Individual">Individual</option>
    </select>
    <label>Tgl. Penawaran/Transaksi</label><input type="date" id="tanggal${counterSampel}">
    <label>Harga Penawaran/Transaksi (Rp)</label><input type="text" id="harga${counterSampel}" oninput="formatRupiah(this)">
    <label>Luas Tanah (m¬≤)</label><input type="number" id="luasTanah${counterSampel}">
    <div id="inputBangunan${counterSampel}">
      <label>Luas Bangunan (m¬≤)</label><input type="number" id="luasBangunan${counterSampel}">
      <label>Tahun Pembuatan</label><input type="number" id="tahunPembuatan${counterSampel}">
      <label>Tahun Renovasi (opsional)</label><input type="number" id="tahunRenovasi${counterSampel}">
      <label>Kondisi Fisik</label>
      <select id="kondisi${counterSampel}">
        <option value="BS">Baik Sekali</option><option value="B">Baik</option>
        <option value="S">Sedang</option><option value="J">Jelek</option><option value="JS">Jelek Sekali</option>
      </select>
      <label>Biaya per m¬≤ Bangunan (Rp)</label><input type="text" id="biaya${counterSampel}" oninput="formatRupiah(this)">
    </div>
  `;
  c.appendChild(d); 
  
  // === LOGIKA AUTO DATE (HARI INI) ===
  const dateInput = document.getElementById(`tanggal${counterSampel}`);
  if(dateInput) {
      const now = new Date();
      // Format YYYY-MM-DD dengan padding 0
      const day = String(now.getDate()).padStart(2, '0');
      const month = String(now.getMonth() + 1).padStart(2, '0'); // Jan = 0
      const year = now.getFullYear();
      dateInput.value = `${year}-${month}-${day}`;
  }

  toggleInput(counterSampel);
}

function hapusSampel(id){
  const el = document.getElementById("sampel"+id);
  if(el){
    el.remove();
    hitungMulti(); // Hitung ulang setelah dihapus
  }
}

function toggleInput(i){
  const jenis=document.getElementById("jenisProperti"+i).value;
  const isLahan=jenis==="lahan";
  const div=document.getElementById("inputBangunan"+i);
  if(div) div.style.display=isLahan?"none":"block";
}

// ============ Proses Hitung (ORIGINAL) ==============
function prosesHitung(jenisProperti,status,jenis,tanggal,harga,luasTanah,luasBangunan,tahunPembuatan,tahunRenovasi,kondisi,biaya){
  // 1. Penyesuaian Penawaran
  let hargaPenyesuaian=(jenis==="Penawaran")?harga*0.9:harga;
  
  // 2. Lahan Kosong
  if(jenisProperti==="lahan"){
    let hargaDasar=hargaPenyesuaian/luasTanah;
    let faktorStatus=(status==="TMA")?0.10:(status==="HGB"||status==="HP")?0.05:0;
    let akhir=new Date("2025-12-31");
    let tahunSelisih=(akhir-tanggal)/(1000*60*60*24*365);
    let persenWaktu=0.10*tahunSelisih;
    let hargaFinal=hargaDasar*(1+persenWaktu+faktorStatus);
    const totalNilaiLahanAdjusted = hargaFinal * luasTanah; 
    
    // OUTPUT IDENTIK SCRIPT 2
    return `
      <div class="result-line"><span>Harga (Disesuaikan)</span><strong>Rp ${Math.round(hargaPenyesuaian).toLocaleString('id-ID')}</strong></div>
      <div class="result-line"><span>Harga Dasar per m¬≤</span><strong>Rp ${Math.round(hargaDasar).toLocaleString('id-ID')}</strong></div>
      <div class="result-line"><span>Penyesuaian Waktu (${(persenWaktu*100).toFixed(2)}%)</span><strong>+Rp ${Math.round(hargaDasar*persenWaktu).toLocaleString('id-ID')}</strong></div>
      <div class="result-line"><span>Penyesuaian Status (${(faktorStatus*100).toFixed(2)}%)</span><strong>+Rp ${Math.round(hargaDasar*faktorStatus).toLocaleString('id-ID')}</strong></div>
      <div class="result-line"><span>Total Nilai Lahan (Adjusted)</span><strong>Rp ${Math.round(totalNilaiLahanAdjusted).toLocaleString('id-ID')}</strong></div>
      <div class="result-final"><span>Harga Akhir per m¬≤</span><span class="value">Rp ${Math.round(hargaFinal).toLocaleString('id-ID')}</span></div>
    `;
  }

  // 3. Bangunan
  biaya=parseFloat((biaya||"0").toString().replace(/\./g,''))||0;
  luasBangunan=parseFloat(luasBangunan)||0;
  tahunPembuatan=parseInt(tahunPembuatan)||0;
  tahunRenovasi=parseInt(tahunRenovasi)||0;

  const tahunPenilaian=2025;
  const NPBB=luasBangunan*biaya;
  let umurEfektif=tahunPenilaian-tahunPembuatan;
  if(tahunRenovasi>tahunPembuatan){
    umurEfektif=((tahunPenilaian-tahunPembuatan)+2*(tahunPenilaian-tahunRenovasi))/3;
  }
  umurEfektif=Math.ceil(Math.max(0,Math.min(50,umurEfektif)));

  let kategori="low";
  if(jenisProperti==="rumah"){kategori=biaya>2000000?"high":"low";}
  else if(jenisProperti==="ruko"){kategori=biaya>3000000?"high":"low";}
  const tabel=tabelPenyusutan[jenisProperti][kategori][kondisi];
  const umurIdx=Math.min(umurEfektif,tabel.length-1);
  const persen=tabel[umurIdx]||0;

  const penyusutan=NPBB*(persen/100);
  const nilaiBangunan=NPBB-penyusutan;
  const hargaTanah=hargaPenyesuaian-nilaiBangunan;
  let faktorStatus=(status==="TMA")?0.10:(status==="HGB"||status==="HP")?0.05:0;
  let akhir=new Date("2025-12-31");
  let tahunSelisih=(akhir-tanggal)/(1000*60*60*24*365);
  let penyesuaianWaktu=tahunSelisih*0.10;
  
  const nilluas=(1+penyesuaianWaktu+faktorStatus)*hargaTanah; 
  const nilai=luasTanah>0?nilluas/luasTanah:0;

  // OUTPUT IDENTIK SCRIPT 2
  return `
    <div class="result-line"><span>Harga (Disesuaikan)</span><strong>Rp ${Math.round(hargaPenyesuaian).toLocaleString('id-ID')}</strong></div>
    <div class="result-line"><span>NPBB</span><strong>Rp ${Math.round(NPBB).toLocaleString('id-ID')}</strong></div>
    <div class="result-line"><span>Umur Efektif</span><strong>${umurEfektif} th</strong></div>
    <div class="result-line"><span>Penyusutan</span><strong>${persen}%</strong></div>
    <div class="result-line"><span>Nilai Bangunan</span><strong>Rp ${Math.round(nilaiBangunan).toLocaleString('id-ID')}</strong></div>
    <div class="result-line"><span>Indikasi Harga Tanah</span><strong>Rp ${Math.round(hargaTanah).toLocaleString('id-ID')}</strong></div>
    <div class="result-line"><span>Penyesuaian Waktu (${(penyesuaianWaktu*100).toFixed(2)}%)</span><strong>+Rp ${Math.round(hargaTanah*penyesuaianWaktu).toLocaleString('id-ID')}</strong></div>
    <div class="result-line"><span>Penyesuaian Status (${(faktorStatus*100).toFixed(2)}%)</span><strong>+Rp ${Math.round(hargaTanah*faktorStatus).toLocaleString('id-ID')}</strong></div>
    <div class="result-line"><span>Total Nilai Tanah (Adjusted)</span><strong>Rp ${Math.round(nilluas).toLocaleString('id-ID')}</strong></div>
    <div class="result-final"><span>Nilai Tanah per m¬≤</span><span class="value">Rp ${Math.round(nilai).toLocaleString('id-ID')}</span></div>
  `;
}

// ============ Hitung Multi (Support Penghapusan) ==============
function hitungMulti(){
  let out=document.getElementById("output"); out.innerHTML=""; let values=[];
  
  for(let i=1;i<=counterSampel;i++){
    if(!document.getElementById("sampel"+i)) continue;

    const jenisProperti=document.getElementById("jenisProperti"+i).value;
    const status=document.getElementById("status"+i).value;
    const jenis=document.getElementById("jenis"+i).value;
    const tanggal=new Date(document.getElementById("tanggal"+i).value);
    const harga=parseFloat((document.getElementById("harga"+i).value||"0").replace(/\./g,''))||0;
    const luasTanah=parseFloat(document.getElementById("luasTanah"+i).value)||0;
    
    if(!tanggal.getTime()||!harga||!luasTanah) continue;

    let hasil=prosesHitung(
      jenisProperti,status,jenis,tanggal,harga,luasTanah,
      document.getElementById("luasBangunan"+i)?.value,
      document.getElementById("tahunPembuatan"+i)?.value,
      document.getElementById("tahunRenovasi"+i)?.value,
      document.getElementById("kondisi"+i)?.value,
      document.getElementById("biaya"+i)?.value
    );

    let parser=new DOMParser(); let doc=parser.parseFromString("<div>"+hasil+"</div>","text/html");
    let valText=doc.querySelector(".result-final .value")?.innerText.replace(/[^\d]/g,"");
    let valNum=parseFloat(valText)||0; if(valNum>0) values.push(valNum);

    out.innerHTML+=`<div class="result"><h4>Hasil Sampel ${i}</h4>${hasil}</div>`;
  }
  
  const isDark = document.body.classList.contains('dark');
  const RSD_COLORS = {
      light: {
          lowRSD_bg: "#d1e7dd", lowRSD_color: "#0a3622", highRSD_bg: "#f8d7da", highRSD_color: "#b00020", warning_bg: "#fff3cd", warning_color: "#664d03"
      },
      dark: {
          lowRSD_bg: "#143e3d", lowRSD_color: "#a6d9b8", highRSD_bg: "#58151c", highRSD_color: "#f5c2c7", warning_bg: "#664d03", warning_color: "#fff3cd"
      }
  };
  const activeColors = isDark ? RSD_COLORS.dark : RSD_COLORS.light;

  if(values.length>1){
    let mean=values.reduce((a,b)=>a+b,0)/values.length;
    let variance=values.reduce((a,b)=>a+Math.pow(b-mean,2),0)/(values.length - 1); 
    let sd=Math.sqrt(variance); 
    let rsd=(sd/mean)*100;
    
    let color= rsd<=25 ? activeColors.lowRSD_color : activeColors.highRSD_color;
    let bg= rsd<=25 ? activeColors.lowRSD_bg : activeColors.highRSD_bg;
    let emoji= rsd<=25 ? "üòÄ" : "üò°";
    
    out.innerHTML+=`
      <div class="result-final" style="background:${bg};color:${color};">
        <span>Standar Deviasi Relatif (RSD)</span>
        <div class="value">${rsd.toFixed(2)}% ${emoji}</div>
      </div>`;
  } else if (values.length === 1) {
    out.innerHTML += `
      <div class="result-final" style="background:${activeColors.warning_bg};color:${activeColors.warning_color};">
        <span>RSD tidak dihitung</span>
        <div class="value">Perlu minimal 2 sampel untuk RSD</div>
      </div>`;
  } else if (values.length === 0) {
    out.innerHTML += `
      <div class="result-final" style="background:${activeColors.highRSD_bg};color:${activeColors.highRSD_color};">
        <span>Perhatian</span>
        <div class="value">Tidak ada sampel dengan data lengkap/valid.</div>
      </div>`;
  }
}

// ============ LOGIKA DARK MODE ============
function toggleDarkMode() {
    const body = document.body;
    body.classList.toggle('dark');
    const isDark = body.classList.contains('dark');
    localStorage.setItem('darkModeEnabled', isDark);
    hitungMulti();
}

function loadDarkModePreference() {
    const isDark = localStorage.getItem('darkModeEnabled') === 'true';
    if (isDark) { document.body.classList.add('dark'); }
}

loadDarkModePreference();
tambahSampel();
</script>
</body>
</html>
